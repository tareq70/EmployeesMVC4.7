@{
    ViewBag.Title = "Employees";
}

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">



<div class="container mt-4">
    <h2>Employees</h2>
    <button id="btnAdd" class="btn btn-primary mb-3">Add Employee</button>


    <table id="employeeTable" class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th></th>
                <th>Id</th>
                <th>Name</th>
                <th>Email</th>
                <th>Department</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>


<!-- Employee Modal -->
<div class="modal fade" id="empModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Employee</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="empId" />
                <div class="mb-3">
                    <label>Name</label>
                    <input type="text" id="empName" class="form-control" />
                </div>
                <div class="mb-3">
                    <label>Email</label>
                    <input type="text" id="empEmail" class="form-control" />
                </div>
                <div class="mb-3">
                    <label>Department</label>
                    <select id="empDepartment" class="form-control">
                        @foreach (var dept in ViewBag.Departments as SelectList)
                        {
                            <option value="@dept.Value">@dept.Text</option>
                        }
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button id="saveEmp" class="btn btn-success">Save</button>
            </div>
        </div>
    </div>
</div>

@section scripts{
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <!-- Buttons Extension -->
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

    <!-- Required for Excel & PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function () {

            // Initialize DataTable
            var table = $('#employeeTable').DataTable({
                ajax: '/Employee/GetEmployees',
                columns: [
                    {
                        className: 'dt-control',  
                        orderable: false,         
                        data: null,               
                        defaultContent: '+'       
                    },
                    { data: 'EmployeeId' },
                    { data: 'Name' },
                    { data: 'Email' },
                    { data: 'DepartmentName' },
                    {
                        data: 'EmployeeId',
                        render: function (id, type, row) {
                            return `
                            <button class="btn btn-sm btn-warning editBtn" data-id="${id}">Edit</button>
                            <button class="btn btn-sm btn-danger deleteBtn" data-id="${id}">Delete</button> `;
                        }
                    }
                ],
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'excelHtml5',
                        title: 'Employees Report',
                        exportOptions: {
                            columns: [0, 1, 2, 3] // exclude Actions
                        }
                    },
                    {
                        extend: 'pdfHtml5',
                        title: 'Employees Report',
                        orientation: 'landscape',
                        pageSize: 'A4',
                        exportOptions: {
                            columns: [0, 1, 2, 3]
                        }
                    }
                ]
            });
            $('#employeeTable tbody').on('click', 'td.dt-control', function () {
                var tr = $(this).closest('tr');
                var btn = $(this);

                if (btn.text() == '+') {
                    tr.nextAll().hide();
                    btn.text('−');
                } else {
                    $('#employeeTable tbody tr').show();
                    $('#employeeTable tbody td.dt-control').text('+');
                }
            });

            // Open Add Modal
            $('#btnAdd').click(function () {
                $('#empId').val('');
                $('#empName').val('');
                $('#empEmail').val('');
                $('#empDepartment').val($('#empDepartment option:first').val());
                var modal = new bootstrap.Modal(document.getElementById('empModal'));
                modal.show();
            });

            // Save Employee (Add/Edit)
            $('#saveEmp').click(function () {
                var id = $('#empId').val();
                var name = $('#empName').val().trim();
                var email = $('#empEmail').val().trim();
                var departmentId = $('#empDepartment').val();

                if (!name || !email) { alert('Name and Email are required'); return; }

                var url = id ? '/Employee/EditEmployee' : '/Employee/AddEmployee';
                var data = id ? { id: id, name: name, email: email, departmentId: departmentId }
                    : { name: name, email: email, departmentId: departmentId };

                $.post(url, data, function (res) {
                    if (res.success) {
                        table.ajax.reload(null, false);
                        var modal = bootstrap.Modal.getInstance(document.getElementById('empModal'));
                        modal.hide();
                    } else {
                        alert(res.message || 'Error occurred');
                    }
                });
            });

            // Edit Employee
            $('#employeeTable').on('click', '.editBtn', function () {
                var row = table.row($(this).parents('tr')).data();
                $('#empId').val(row.EmployeeId);
                $('#empName').val(row.Name);
                $('#empEmail').val(row.Email);
                $('#empDepartment').val(row.DepartmentId);
                var modal = new bootstrap.Modal(document.getElementById('empModal'));
                modal.show();
            });

            // Delete Employee
            $('#employeeTable').on('click', '.deleteBtn', function () {
                if (!confirm('Are you sure?')) return;
                var id = $(this).data('id');

                $.post('/Employee/DeleteEmployee', { id: id }, function (res) {
                    if (res.success) table.ajax.reload(null, false);
                    else alert(res.message || 'Error occurred');
                });
            });

        });
    </script>
}
