@{
    ViewBag.Title = "Departments";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">

<div class="container mt-4">
    <h2>Departments</h2>

    <!-- Add Department Button -->
    <button id="btnAdd" class="btn btn-primary mb-3" type="button">Add Department</button>

    <!-- Departments Table -->
    <table id="departmentTable" class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th>Id</th>
                <th>Name</th>
                <th>Actions</th>
            </tr>
        </thead>
    </table>
</div>

<!-- Bootstrap Modal -->
<div class="modal fade" id="deptModal" tabindex="-1" aria-labelledby="deptModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deptModalLabel">Department</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="deptId" />
                <div class="mb-3">
                    <label for="deptName" class="form-label">Name</label>
                    <input type="text" class="form-control" id="deptName" placeholder="Department Name" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="saveDept" class="btn btn-success">Save</button>
            </div>
        </div>
    </div>
</div>

@section scripts{
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<!-- Buttons Extension -->
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

<!-- Required for Excel & PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function () {

        // Initialize DataTable
        var table = $('#departmentTable').DataTable({
            ajax: '/Department/GetDepartments',
            columns: [
                { data: 'DepartmentId' },
                { data: 'Name' },
                {
                    data: 'DepartmentId',
                    render: function (id) {
                        return `<button class="btn btn-sm btn-warning editBtn" data-id="${id}">Edit</button>
                                                            <button class="btn btn-sm btn-danger deleteBtn" data-id="${id}">Delete</button>`;
                    }
                }
            ],
            dom: 'Bfrtip',
            buttons: [
                {
                    extend: 'excelHtml5',
                    title: 'Employees Report',
                    exportOptions: {
                        columns: [0, 1, 2, 3] // exclude Actions
                    }
                },
                {
                    extend: 'pdfHtml5',
                    title: 'Employees Report',
                    orientation: 'landscape',
                    pageSize: 'A4',
                    exportOptions: {
                        columns: [0, 1, 2, 3]
                    }
                }
            ]
        });

        // Open Add Department Modal
        $('#btnAdd').click(function () {
            $('#deptId').val('');
            $('#deptName').val('');
            var modalEl = document.getElementById('deptModal');
            var modal = new bootstrap.Modal(modalEl);
            modal.show();
        });

        // Save Department (Add/Edit)
        $('#saveDept').click(function () {
            var id = $('#deptId').val();
            var name = $('#deptName').val().trim();
            if (!name) { alert('Name is required'); return; }

            var url = id ? '/Department/EditDepartment' : '/Department/AddDepartment';
            var data = id ? { id: id, name: name } : { name: name };

            $.post(url, data, function (res) {
                if (res.success) {
                    table.ajax.reload(null, false); // reload table without resetting pagination
                    var modalEl = document.getElementById('deptModal');
                    var modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();
                } else {
                    alert(res.message || 'Error occurred');
                }
            });
        });

        // Edit Department
        $('#departmentTable').on('click', '.editBtn', function () {
            var row = table.row($(this).parents('tr')).data();
            $('#deptId').val(row.DepartmentId);
            $('#deptName').val(row.Name);
            var modalEl = document.getElementById('deptModal');
            var modal = new bootstrap.Modal(modalEl);
            modal.show();
        });

        // Delete Department
        $('#departmentTable').on('click', '.deleteBtn', function () {
            if (!confirm('Are you sure?')) return;
            var id = $(this).data('id');

            $.post('/Department/DeleteDepartment', { id: id }, function (res) {
                if (res.success) table.ajax.reload(null, false);
                else alert(res.message || 'Error occurred');
            });
        });

    });
</script>
}
